---
title: "Analisi esplorative"
output: html_document
date: "2025-06-17"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(Matrix)
library(jsonlite)
library(arrow)
library(png)
library(SummarizedExperiment)
library(S4Vectors)
library(ggspavis)
library(SpatialExperiment)
library(patchwork)
library(VisiumIO)
library(edgeR)
library(scater)
library(scuttle)
library(scran)
library(dplyr)
library(SingleCellExperiment)
library(tidyverse)
library(SpotSweeper)
```

# Analisi Esplorativa - bin da 16 micron

Analisi pseudo bulk dei dati a risoluzione 16 micron.

```{r, include=FALSE}

Visium2HD <- function(bin = "008", blocco_num = "blocco1", directory =  "/mnt/europa/data/sandri/241219_A00626_0902_AHWH77DMXY_3/space_out/")
{
  # definiamo la directory
  dir <- paste0(directory,"/",blocco_num, "/outs")
  
  spe <- TENxVisiumHD(
  spacerangerOut = dir,
  processing = "raw",
  images = c("hires","lowres"),
  bin_size = bin,
  jsonFile = "scalefactors_json.json",
  tissuePattern = "tissue_positions.parquet",
  spatialCoordsNames = c("pxl_col_in_fullres", "pxl_row_in_fullres")
) |> import()
  return(spe)
}

load("~/liste_tissue_cond_008.RData")
#load("~/liste_tissue_cond_016.RData")

```

#FILTRAGGIO
```{r}

#Filtrare anche i geni già in questa fase?

processa_blocco <- function(blocco_num, lista_contissue) {
  blocco_nome <- paste0("blocco", blocco_num)
  speHD <- Visium2HD(bin = "008", blocco = blocco_nome) #HO MESSO 16BIN 
  
  #Filtro per in/out of tissue (da qupath) e distinguo i 3 campioni
  speHD$tissue_type <- lista_contissue[[blocco_nome]]$exp_condition
  speHD_f <- speHD[, lista_contissue[[blocco_nome]]$in_tissue == TRUE]
  rm(speHD)
  
  #Creo due colonne per portarmi dietro le informazioni sul numero
  #totale di conteggi e di geni rilevati per ogni spot.
  colData(speHD_f)$ncounts <- colSums(assay(speHD_f))
  colData(speHD_f)$ngenes <- Matrix::colSums(assay(speHD_f) > 0)
  
  # Scatterplot
  plot(colData(speHD_f)$ncounts, colData(speHD_f)$ngenes,
       main = paste("Blocco", blocco_num),
       xlab = "ncounts", ylab = "ngenes")
  #fare la stessa cosa anche con le info sui pixel
  
  # Filtro su base UMI e geni
  speHD_f <- speHD_f[, colData(speHD_f)$ncounts >= quantile(colData(speHD_f)$ncounts, 0.05) &
                       colData(speHD_f)$ngenes >= quantile(colData(speHD_f)$ngenes, 0.05)]
  
  assign(paste0("speHD", blocco_num, "_f"), speHD_f, envir = .GlobalEnv)
}

processa_blocco(1,lista_contissue)

# for (b in c(1:7, 9)) {
#   processa_blocco(b, lista_contissue)
# }
# 
# dim(speHD1_f)
# dim(speHD2_f)
# dim(speHD3_f)
# dim(speHD4_f)
# dim(speHD5_f)
# dim(speHD6_f)
# dim(speHD7_f)
# dim(speHD9_f)
```

#Controllo geni mitocondriali e ribosomiali (non ce ne sono)
```{r}
rownames(speHD2_f) <- rowData(speHD2_f)$Symbol
mt <- grepl("^Mt-", rownames(speHD2_f))
rpl <- grepl("^Rpl-", rownames(speHD2_f))
rps <- grepl("^Rps-", rownames(speHD2_f))
#(stessi geni x tutti)
```

# Grafici dei muscoli per ogni blocco
```{r child = "Plot_muscoli.Rmd"}
```


# Analisi Pseudo Bulk

Aggregazione blocchi: creiamo un unico oggetto single-cell in cui si possono distinguere
i vari campioni, grazie alle variabili che identificano il blocco e il tipo di campione.

```{r}

tissue_type <- c(
  speHD1_f$tissue_type,
  speHD2_f$tissue_type,
  speHD3_f$tissue_type,
  speHD4_f$tissue_type,
  speHD5_f$tissue_type,
  speHD6_f$tissue_type,
  speHD7_f$tissue_type,
  speHD9_f$tissue_type
)
#table(tissue_type)

blocco_id <- c(rep(1,dim(speHD1_f)[2]),
               rep(2,dim(speHD2_f)[2]),
               rep(3,dim(speHD3_f)[2]),
               rep(4,dim(speHD4_f)[2]),
               rep(5,dim(speHD5_f)[2]),
               rep(6,dim(speHD6_f)[2]),
               rep(7,dim(speHD7_f)[2]),
               rep(9,dim(speHD9_f)[2])
)
blocco_id <- as.factor(blocco_id)    

conteggi <- cbind(counts(speHD1_f),
                  counts(speHD2_f),
                  counts(speHD3_f),
                  counts(speHD4_f),
                  counts(speHD5_f),
                  counts(speHD6_f),
                  counts(speHD7_f),
                  counts(speHD9_f)
)

# dim(conteggi)
# length(blocco_id)
# length(tissue_type)

#OGGETTO SINGLE CELL
coldata <- DataFrame(sampletype=tissue_type, blocco = blocco_id)

sce <- SingleCellExperiment(
  assays = list(counts = conteggi),
  colData = coldata
)
sce
colData(sce)

sce$sample <- paste0(sce$sampletype,"_",sce$blocco)

# Genes filtering: keep the genes that have an expression average greater
# than zero in at least of 10% for each (sample?).
# keep <- apply(counts(sce), 1, function(y) all(tapply(y, sce$sample, function(x) mean(x > 0)) >= 0.1))
# fil_sce <- sce[keep, ]

```



Creiamo un oggetto pseudobulk a partire dall'oggetto single-cell.

```{r}
pb <- aggregateAcrossCells(sce, ids=DataFrame(tissue = sce$sampletype,
                                              blocco = sce$blocco))
pb
rownames(pb) <- rowData(speHD1_f)$Symbol

```

#Normalizziamo i dati con una TMM
```{r, message=FALSE, warning=FALSE}
raw_counts <- assay(pb, "counts") 
dge <- DGEList(counts = raw_counts)
dge <- calcNormFactors(dge, method = "TMM")
log_cpm <- cpm(dge, log = TRUE)
colnames(pb) <- c("Sample1","Sample2","Sample3","Sample4","Sample5","Sample6","Sample7",
                  "Sample8", "Sample9","Sample10","Sample11","Sample12","Sample13","Sample14",
                  "Sample15","Sample16","Sample17","Sample18","Sample19","Sample20","Sample21",
                  "Sample22","Sample23","Sample24")
logcounts(pb) <- log_cpm

```

## PCA e altri metodi di riduzione della dimensionalità

```{r, include=FALSE}
#PCA
pb <- runPCA(pb, BSPARAM = BiocSingular::ExactParam(), ncomponents=2)
plotPCA(pb, color_by = "sampletype", point_size=8)
plotPCA(pb, color_by = "blocco", point_size=8)

```

```{r, include=FALSE}
#TSNE
pb <- runTSNE(pb, dimred = "PCA", perplexity = 2)
plotTSNE(pb, color_by = "sampletype", point_size = 8)

```

```{r, include=FALSE}
#UMAP
pb <- runUMAP(pb, dimred = "PCA", n_neighbors = 3)
plotUMAP(pb, color_by = "sampletype", point_size = 8)

```

Guardiamo la decomposizione della varianza dei geni, poi mantenendo solo i 5000
geni più variabili guardiamo PCA, T-SNE e UMAP per avere un'indicazione di come
si dispongono i campioni in uno spazio ridotto e osservare eventuali aggregazioni
basate sul tipo di campione e sul blocco.
```{r, message=FALSE, warning=FALSE}

dec.pb <- modelGeneVar(pb, assay.type = "logcounts")

#Decomposizione varianza
summary_table <- tibble::tibble(
  Descrizione = c(
    "Totale geni",
    "NA (non stimata)",
    "Var. bio <= 0",
    "Var. bio > 0",
    "FDR < 0.05 (TRUE)",
    "FDR < 0.01 (TRUE)"
  ),
  Valore = c(
    nrow(dec.pb),
    sum(is.na(dec.pb$bio)),
    sum(!is.na(dec.pb$bio) & dec.pb$bio <= 0),
    sum(!is.na(dec.pb$bio) & dec.pb$bio > 0),
    sum(dec.pb$FDR < 0.05, na.rm = TRUE),
    sum(dec.pb$FDR < 0.01, na.rm = TRUE)
  )
)

print(summary_table)

#Prendiamo 5000 geni (circa il 15%)
top5000_genes <- getTopHVGs(dec.pb, n = 5000)
pb_vg <- pb[top5000_genes, ]

#PCA SUI GENI + VARIABILI
pb_vg <- runPCA(pb_vg, BSPARAM = BiocSingular::ExactParam(), ncomponents=2)
plotPCA(pb_vg, color_by = "sampletype", point_size=6)

pb_vg <- runPCA(pb_vg, BSPARAM = BiocSingular::ExactParam(), ncomponents=2)
plotPCA(pb_vg, color_by = "blocco", point_size=6)

#Varianza spiegata CP
pca <- prcomp(t(log_cpm), scale. = TRUE)
var_explained <- (pca$sdev)^2 / sum((pca$sdev)^2)
percent_var <- round(100 * var_explained, 1)

#SCREE PLOT COMPONENTI PRINCIPALI
elbow_df <- data.frame(PC = paste0("PC", 1:length(var_explained)),
                       VarianceExplained = var_explained)

ggplot(elbow_df[1:12, ], aes(x = seq_along(VarianceExplained), y = VarianceExplained)) +
  geom_point() + geom_line() + theme_minimal() +
  labs(title = "Elbow Plot", x = "Principal Component", y = "Proportion of Variance Explained")

#UMAP CON GENI + VARIABILI
pb_vg <- runUMAP(pb_vg, dimred = "PCA", n_neighbors = 3)
plotUMAP(pb_vg, color_by = "sampletype", point_size = 8)

#TSNE CON GENI + VARIABILI
pb_vg <- runTSNE(pb_vg, dimred = "PCA", perplexity = 2)
plotTSNE(pb_vg, color_by = "sampletype", point_size = 8)

```

### Boxplot dei logcounts
```{r}
df_long <- as.data.frame(log_cpm) |>
  pivot_longer(
    cols = everything(),
    names_to = "sample",
    values_to = "expression"
  )

ggplot(df_long, aes(x = sample, y = expression)) +
  geom_boxplot(outlier.shape = NA) +  # outline=FALSE
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +  # las=2
  labs(x = "Sample", y = "Log expression")

#counts
# df_long <- as.data.frame(counts(pb)) |>
#   pivot_longer(
#     cols = everything(),
#     names_to = "sample",
#     values_to = "expression"
#   )
# 
# ggplot(df_long, aes(x = sample, y = expression)) +
#   geom_boxplot(outlier.shape = NA) +  # outline=FALSE
#   theme_minimal() +
#   theme(axis.text.x = element_text(angle = 90, hjust = 1)) +  # las=2
#   labs(x = "Sample", y = "Log expression")

#PER TIPO DI CAMPIONE
df_long$sampletype <- colData(pb)$sampletype[match(df_long$sample, colnames(pb))]

df_long$sample <- factor(df_long$sample, levels = df_long %>%
  distinct(sample, sampletype) %>%
  arrange(sampletype, sample) %>%
  pull(sample))

ggplot(df_long, aes(x = sample, y = expression, fill = sampletype)) +
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Sample", y = "Log expression", fill = "Tipo campione")

#PER BLOCCO
df_long$blocco <- colData(pb)$blocco[match(df_long$sample, colnames(pb))]

df_long$sample <- factor(df_long$sample, levels = df_long %>%
  distinct(sample, blocco) %>%
  arrange(blocco, sample) %>%
  pull(sample))

ggplot(df_long, aes(x = sample, y = expression, fill = blocco)) +
  geom_boxplot(outlier.shape = NA) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) +
  labs(x = "Sample", y = "Log expression", fill = "Blocco")

```

### Tabella valori riassuntivi per campione
```{r}
estrai_info <- function(speHD, nome_campione) {
  tt <- unique(colData(speHD)$tissue_type)
  
  res <- lapply(tt, function(t) {
    n_spot <- sum(colData(speHD)$tissue_type == t)
    total_umi <- sum(colData(speHD)$ncounts[colData(speHD)$tissue_type == t])
    n_geni <- sum(rowSums(counts(speHD)[, colData(speHD)$tissue_type == t]) != 0)
    
    data.frame(
      Campione = nome_campione,
      Tissue_Type = t,
      Numero_Spot = n_spot,
      Totale_UMI = total_umi,
      Geni_Detectati = n_geni
    )
  })
  
  do.call(rbind, res)
}

df1 <- estrai_info(speHD1_f, "Blocco1")
df2 <- estrai_info(speHD2_f, "Blocco2")
df3 <- estrai_info(speHD3_f, "Blocco3")
df4 <- estrai_info(speHD4_f, "Blocco4")
df5 <- estrai_info(speHD5_f, "Blocco5")
df6 <- estrai_info(speHD6_f, "Blocco6")
df7 <- estrai_info(speHD7_f, "Blocco7")
df9 <- estrai_info(speHD9_f, "Blocco9")

#Tabella
tabella_finale <- rbind(df1, df2, df3, df4, df5, df6, df7, df9)
tabella_finale <- tabella_finale[order(tabella_finale$Tissue_Type, tabella_finale$Campione), ]
tabella_finale <- tabella_finale[, c("Tissue_Type", "Campione", "Numero_Spot", "Totale_UMI", "Geni_Detectati")]
print(tabella_finale)

```

#GRAFICI RIFERITI ALLA TABELLA SOPRA
```{r}
library(readxl)
dati <- read_xlsx("tab_rias.xlsx")

colnames(dati)

nuova_colonna <- paste0(dati$Tissue_Type, "_", dati$Campione)
dati$unita_stat <- nuova_colonna
library(ggplot2)

ggplot(dati, aes(x = Tissue_Type, y = Totale_UMI, fill = Campione)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "Barplot Totale UMI per Campione",
       x = "Campione",
       y = "Totale UMI") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::label_number(big.mark = " "))
ggsave("barplot_UMI_campione.png", dpi = 300)
ggplot(dati, aes(x = Campione, y = Totale_UMI, fill = Tissue_Type)) +
  geom_bar(stat = "identity", position = "dodge") +
  theme_minimal() +
  labs(title = "Barplot Totale UMI per Blocco",
       x = "Blocco",
       y = "Totale UMI") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = scales::label_number(big.mark = " "))
ggsave("barplot_UMI_blocco.png", dpi = 300)

library(tidyr)

# Porta i dati in formato long
dati |> 
  pivot_longer(cols = c(Numero_Spot, Geni_Detectati),
               names_to = "Variabile",
               values_to = "Valore") |>
ggplot(aes(x = unita_stat, y = Valore, fill = Variabile)) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.9)) +
  theme_minimal() +
  labs(title = "Numero di spot e Geni unici per campione",
       x = "Campione",
       y = "",
       fill = "Variabili") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("barplot_Nspot_geni_campione.png")  

```


#Aalisi dei geni differenzialmente espressi
```{r}

#Oggetto DGEList
y <- DGEList(counts(pb), samples = colData(pb))
#filtraggio geni
y <- y[rowSums(y$counts) > 0, ]
#per filtrare un po' di più
min_samples <- ceiling(0.1 * ncol(y$counts))
y <- y[rowSums(y$counts > 0) >= min_samples, ]

#Normalizzazione TMM
y <- calcNormFactors(y)

#Matrice del modello
design <- model.matrix(~ sampletype, data = y$samples)

#Stima dispersione e del modello
y <- estimateDisp(y, design)
fit <- glmFit(y, design)

#Contrasti:
contrast_list <- list(
    "C26_vs_SHAM" = makeContrasts(sampletypec26 - sampletypesham, levels = make.names(colnames(design))),
    "FOXO_vs_C26" = makeContrasts(-sampletypec26, levels = make.names(colnames(design))),
    "FOXO_vs_SHAM" = makeContrasts(-sampletypesham - sampletypesham, levels = make.names(colnames(design))),
    "STAT3_vs_C26" = makeContrasts(sampletypec26STAT3 - sampletypec26, levels = make.names(colnames(design))),
    "STAT3_vs_SHAM" = makeContrasts(sampletypec26STAT3 - sampletypesham, levels = make.names(colnames(design))),
    "MURF1_vs_C26" = makeContrasts(sampletypec26murf1 - sampletypec26, levels = make.names(colnames(design))),
    "MURF1_vs_SHAM" = makeContrasts(sampletypec26murf1 - sampletypesham, levels = make.names(colnames(design))),
    "SMAD23_vs_C26" = makeContrasts(sampletypec26SMAD23 - sampletypec26, levels = make.names(colnames(design))),
    "SMAD23_vs_SHAM" = makeContrasts(sampletypec26SMAD23 - sampletypesham, levels = make.names(colnames(design)))
  )

lrt1 <- glmLRT(fit, contrast = contrast_list$FOXO_vs_C26)
lrt2 <- glmLRT(fit, contrast = contrast_list$C26_vs_SHAM)
lrt3 <- glmLRT(fit, contrast = contrast_list$FOXO_vs_SHAM)
lrt4 <- glmLRT(fit, contrast = contrast_list$STAT3_vs_C26)
lrt5 <- glmLRT(fit, contrast = contrast_list$STAT3_vs_SHAM)
lrt6 <- glmLRT(fit, contrast = contrast_list$MURF1_vs_C26)
lrt7 <- glmLRT(fit, contrast = contrast_list$MURF1_vs_SHAM)
lrt8 <- glmLRT(fit, contrast = contrast_list$SMAD23_vs_C26)
lrt9 <- glmLRT(fit, contrast = contrast_list$SMAD23_vs_SHAM)
```

#VISUALIZZAZIONE E SALVATAGGIO RISULTATI
```{r}
library(openxlsx)

analizza_confronto <- function(lrt_obj, nome_prefix) {
  
  res <- topTags(lrt_obj, n = Inf)$table
  res$significant <- res$FDR < 0.05
  
  sig <- res[res$significant, ]
  sig_up <- sig[sig$logFC >= 0, ]
  sig_down <- sig[sig$logFC < 0, ]
  
  wb <- createWorkbook()
  addWorksheet(wb, "Tutti_geni")
  writeData(wb, "Tutti_geni", res, rowNames = TRUE)
  addWorksheet(wb, "Significativi")
  writeData(wb, "Significativi", sig, rowNames = TRUE)
  addWorksheet(wb, "Upregolati")
  writeData(wb, "Upregolati", sig_up, rowNames = TRUE)
  addWorksheet(wb, "Downregolati")
  writeData(wb, "Downregolati", sig_down, rowNames = TRUE)
  saveWorkbook(wb, paste0("dge_", nome_prefix, ".xlsx"), overwrite = TRUE)
  
  gene_summary <- data.frame(
    Descrizione = c(
      "Geni considerati",
      "Geni DE (significativi)",
      "Geni DE upregolati",
      "Geni DE downregolati"
    ),
    Numero = c(
      nrow(res),
      nrow(sig),
      nrow(sig_up),
      nrow(sig_down)
    )
  )
  
  return(gene_summary)
}

set.seed(1847)
(ris1 <- analizza_confronto(lrt1, "FOXO_C26"))
(ris2 <- analizza_confronto(lrt2, "C26_SHAM"))
(ris3 <- analizza_confronto(lrt3, "FOXO_SHAM"))
(ris4 <- analizza_confronto(lrt4, "STAT3_C26"))
(ris5 <- analizza_confronto(lrt5, "STAT3_SHAM"))
(ris6 <- analizza_confronto(lrt6, "MURF1_C26"))
(ris7 <- analizza_confronto(lrt7, "MURF1_SHAM"))
(ris8 <- analizza_confronto(lrt8, "SMAD23_C26"))
(ris9 <- analizza_confronto(lrt9, "SMAD23_SHAM"))

```



