---
title: "spot_dec"
output: html_document
date: "2025-07-21"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(arrow)
library(Banksy)
library(BiocParallel)
library(DropletUtils)
library(dplyr)
library(edgeR)
library(ggplot2)
library(graphics)
library(igraph)
library(jsonlite)
library(Matrix)
library(OSTA.data)
library(patchwork)
library(pheatmap)
library(S4Vectors)
library(scDblFinder)
library(scater)
library(scran)
library(scuttle)
library(SingleCellExperiment)
library(SpatialExperiment)
library(SummarizedExperiment)
library(tidyr)
library(VisiumIO)
library(spacexr)
library(SpotSweeper)
library(ggspavis)
library(writexl)
library(lme4)
```

#Deconvolution function
For each spot the probability for each cell type as well as the label of the principal cell type are saved.
```{r}
run_my_rctd <- function(spe, sce_ref, out_prefix) {
  set.seed(9237)
  rownames(spe) <- rowData(spe)$Symbol
  rownames(spe) <- make.unique(rownames(spe))
  
  #data preparation
  rctd_data <- createRctd(
    spatial_experiment = spe,
    reference_experiment = sce_ref,
    cell_type_col = "subclusters"
  )
  
  #deconvolution
  results <- runRctd(rctd_data, rctd_mode = "multi")
  
  #weights extraction
  ws <- assay(results, "weights")
  ws <- data.frame(t(as.matrix(ws)))
  colData(spe)[names(ws)] <- ws[colnames(spe), ] 
  
  #Cluster labelling
  ids <- names(ws)[apply(ws, 1, which.max)]
  ids <- gsub("\\.([A-z])", " \\1", ids)
  idx <- match(colnames(spe), rownames(ws))
  spe$cell_type <- factor(ids[idx]) 
  print(table(spe$cell_type))
  
  assign("subset_list", replace(subset_list, out_prefix, spe), envir = .GlobalEnv)
  invisible(spe)
}
```

Creating a list of spatial experiment objects (one for each sample) and applying the deconvolution
to all samples separately.
```{r}
sce_ref <- readRDS("~/multiome_sce.rds") #reference dataset from multiome

# loading visium HD objects from "analisi esplorative" (one for each block)
for (i in c(1,2,3,4,5,6,7,9)) {
    load(paste0("~/speHD", i, "_g.RData"))
}

spe_list <- list(
    speHD1_g = speHD1_g,
    speHD2_g = speHD2_g,
    speHD3_g = speHD3_g,
    speHD4_g = speHD4_g,
    speHD5_g = speHD5_g,
    speHD6_g = speHD6_g,
    speHD7_g = speHD7_g,
    speHD9_g = speHD9_g
)

subset_list <- list()

#separating blocks into the 3 samples (using tissue_type) and then placing all spatial
#experiment objects in a new list.
for (spe_name in names(spe_list)) {
    spe_obj <- spe_list[[spe_name]]
    tissue_types <- unique(colData(spe_obj)$tissue_type)
    for (tissue in tissue_types) {
        subset_obj <- spe_obj[, colData(spe_obj)$tissue_type == tissue]
        out_name <- paste0(tissue, "_", gsub("speHD", "b", gsub("_g", "", spe_name)))
        subset_list[[out_name]] <- subset_obj
    }
}

#calling deconvolution on each sample
for (name in names(subset_list)) {
    run_my_rctd(subset_list[[name]], sce_ref, name)
}

save(subset_list,file="subset_list.RData")

```

Plots to show deconvolution on tissue: for each sample 2 plots are created. In the first, for all cell types
spots are coloured according to the probabiluty (weigth) for that cell type. In the second one, each
spot is coloured according to its clustering labels (the cell type with highest weigth).
```{r}

p <- lapply(names(ws), \(.) 
    plotCoords(spe, annotate = ., point_size = 0.1)
  ) |>
    wrap_plots(nrow = 3, ncol=5, guides = "collect") & 
    theme(
      legend.key.width = unit(0.5, "lines"),
      legend.key.height = unit(1, "lines"),
      strip.text = element_text(size = 5) 
    ) & 
    scale_color_gradientn(colors = rev(hcl.colors(9, "Rocket")))
  
ggsave(paste0(out_prefix, "_types.png"), p, width = 10, height = 8, dpi = 300)
  
your_color_vector <- c(
    "Endothelial" = "#0072B2",       # blu vivo
    "FAPs" = "#009E73",              # verde vivo
    "Immune_Cells" = "#D55E00",      # arancione-rosso
    "MuSC" = "#E69F00",              # arancione
    "Myonuclei_IIb" = "#CC79A7",     # magenta
    "Myonuclei_IIx" = "#56B4E9",     # azzurro chiaro
    "Myonuclei_IIx_IIa" = "#F0E442", # giallo
    "Myonuclei_IIx_IIb" = "#9B59B6", # viola chiaro
    "Myonuclei_MTJ" = "#0099B4",     # turchese
    "Myonuclei_NMJ" = "#DDAA33",     # senape
    "Myonuclei_Trim63" = "#CC3311",  # rosso scuro
    "Nervous_System" = "#44AA99",    # verde acqua
    "Pericyte" = "#AA4499",          # viola/rosa
    "Smooth_Muscular" = "#332288",   # blu-viola scuro
    "Tenocyte" = "#A3E635"           # verde lime
)

stat1 <- plotCoords(spe, annotate = "cell_type", point_size = 0.5) +
    scale_color_manual(values = your_color_vector) +
    theme(
      legend.key.width = unit(0.5, "lines"),
      legend.key.height = unit(1, "lines")
    )
  
ggsave(paste0(out_prefix, "_dec.png"), stat1, width = 10, height = 8, dpi = 300)
  
```

#Barplot to show cell type proportions for each sample
```{r}

load("subset_list.RData")

prop_df <- lapply(names(subset_list), function(name) {
  spe <- subset_list[[name]]
  tab <- table(spe$cell_type)
  prop <- prop.table(tab)
  data.frame(
    sample = name,
    cell_type = names(prop),
    proportion = as.numeric(prop)
  )
}) |> bind_rows()

your_color_vector <- c(
    "Endothelial" = "#0072B2",       # blu vivo
    "FAPs" = "#009E73",              # verde vivo
    "Immune_Cells" = "#D55E00",      # arancione-rosso
    "MuSC" = "#E69F00",              # arancione
    "Myonuclei_IIb" = "#CC79A7",     # magenta
    "Myonuclei_IIx" = "#56B4E9",     # azzurro chiaro
    "Myonuclei_IIx_IIa" = "#F0E442", # giallo
    "Myonuclei_IIx_IIb" = "#9B59B6", # viola chiaro
    "Myonuclei_MTJ" = "#0099B4",     # turchese
    "Myonuclei_NMJ" = "#DDAA33",     # senape
    "Myonuclei_Trim63" = "#CC3311",  # rosso scuro
    "Nervous_System" = "#44AA99",    # verde acqua
    "Pericyte" = "#AA4499",          # viola/rosa
    "Smooth_Muscular" = "#332288",   # blu-viola scuro
    "Tenocyte" = "#A3E635"           # verde lime
)

ggplot(prop_df, aes(x = sample, y = proportion, fill = cell_type)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = your_color_vector) +
  theme_minimal() +
  labs(
    title = "Proporzioni dei tipi cellulari per campione",
    x = "Campione (subset_list)",
    y = "Proporzione",
    fill = "Tipo Cellulare"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("cell_type_proportions.png", width = 10, height = 6, dpi = 300)

```

#Barplot to show cell types proportions for each condition
From this point on block 7 samples won't be considered anymore.
```{r}
list_wb7 <- subset_list[!names(subset_list) %in% c("c26_b7","c26STAT3_b7","sham_b7")]
prop_df_condition <- lapply(list_wb7, function(spe) {
  data.frame(
    tissue_type = unique(spe$tissue_type),
    cell_type = spe$cell_type
  )
}) |> bind_rows() |> filter(!is.na(cell_type))

prop_df_condition <- prop_df_condition %>%
  count(tissue_type, cell_type) %>%
  group_by(tissue_type) %>%
  mutate(proportion = n / sum(n)) %>%
  ungroup()

ggplot(prop_df_condition, aes(x = tissue_type, y = proportion, fill = cell_type)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = your_color_vector) +
  theme_minimal() +
  labs(
    title = "Proporzioni dei tipi cellulari per condizione",
    x = "Condizione (tissue_type)",
    y = "Proporzione",
    fill = "Tipo Cellulare"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("cell_type_proportions_by_condition.png", width = 10, height = 6, dpi = 300)

```

#Same barplot for multiome annotations for comparison
```{r}

sce_ref <- readRDS("multiome_sce.rds")
sce_ref 
table(colData(sce_ref)$condition)

prop_df_condition <- 
  data.frame(
    tissue_type = colData(sce_ref)$condition,
    cell_type =  colData(sce_ref)$subclusters
  )

prop_df_condition <- prop_df_condition %>%
  count(tissue_type, cell_type) %>%
  group_by(tissue_type) %>%
  mutate(proportion = n / sum(n)) %>%
  ungroup()

ggplot(prop_df_condition, aes(x = tissue_type, y = proportion, fill = cell_type)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = your_color_vector) +
  theme_minimal() +
  labs(
    title = "Proporzioni dei tipi cellulari per condizione",
    x = "Condizione (tissue_type)",
    y = "Proporzione",
    fill = "Tipo Cellulare"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("cell_type_multiome.png", width = 10, height = 6, dpi = 300)

```

#Table to see proportions 
```{r}
#by sample
celltype_table <- lapply(names(subset_list), function(sample_name) {
  spe <- subset_list[[sample_name]]
  df <- as.data.frame(colData(spe))
  df <- df %>%
    group_by(cell_type) %>%
    summarise(count = n()) %>%
    mutate(proportion = count / sum(count),
           sample = sample_name)
  df
}) %>%
  bind_rows()

celltype_matrix <- celltype_table %>%
  select(sample, cell_type, proportion) %>%
  pivot_wider(names_from = cell_type, values_from = proportion, values_fill = 0)

celltype_matrix
#write_xlsx(celltype_matrix, "celltype_proportions_per_sample.xlsx")

#by condition
ct_long <- lapply(list_wb7, function(spe) {
  data.frame(
    tissue_type = unique(spe$tissue_type), 
    cell_type   = spe$cell_type
  )
}) %>%
  bind_rows()

counts <- ct_long %>%
  count(tissue_type, cell_type, name = "n")

props <- counts %>%
  group_by(tissue_type) %>%
  mutate(prop = n / sum(n)) %>%
  ungroup()

props_wide <- props %>%
  select(tissue_type, cell_type, prop) %>%
  pivot_wider(names_from = cell_type, values_from = prop, values_fill = 0)

write_xlsx(props_wide, path = "celltype_by_tissue_type.xlsx")

```

#boxplot of cell type proportions stratified by condition
```{r}
prop_per_sample <- lapply(names(list_wb7), function(sample_name) {
  spe <- subset_list[[sample_name]]
  df <- data.frame(
    sample = sample_name,
    tissue_type = unique(spe$tissue_type),
    cell_type = spe$cell_type
  )
  
  df <- df %>%
    group_by(cell_type) %>%
    summarise(count = n(), .groups = "drop") %>%
    mutate(proportion = count / sum(count),
           sample = sample_name,
           tissue_type = unique(spe$tissue_type))
  
  df
}) %>% bind_rows()

ggplot(prop_per_sample, aes(x = tissue_type, y = proportion, fill = tissue_type)) +
  geom_boxplot(outlier.shape = 21) +
  facet_wrap(~ cell_type, scales = "free_y") +
  scale_fill_manual(values = c("sham" = "#1b9e77", "c26" = "#d95f02")) +
  theme_minimal(base_size = 12) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(title = "Distribuzione proporzioni cell_type per tissue_type",
       x = "Tissue type",
       y = "Proporzione")
ggsave("boxplot_celltype_prop_by_cond.png", width = 10, height = 6, dpi = 300)

```

#Spatial relationship between trim and 2b myo
```{r}

default_color <- "white"

your_color_vector <- setNames(
  rep(default_color, 16),
  c("Endothelial", "FAPs", "Immune_Cells", "MuSC", "Myonuclei_IIx",
    "Myonuclei_IIx_IIa", "Myonuclei_IIx_IIb", "Myonuclei_MTJ",
    "Myonuclei_NMJ", "Nervous_System", "Pericyte",
    "Smooth_Muscular", "Tenocyte",
    "Myonuclei_IIb", "Myonuclei_Trim63")
)

your_color_vector["Myonuclei_IIb"]     <- "blue"
your_color_vector["Myonuclei_Trim63"]  <- "red"

plot_list <- lapply(names(subset_list), function(nm) {
  spe <- subset_list[[nm]]
  
  plotCoords(spe, annotate = "cell_type", point_size = 0.7) +
    scale_color_manual(values = your_color_vector, na.value = default_color) +
    ggtitle(nm) +   # <- titolo con il nome del campione
    theme(
      legend.key.width  = unit(0.5, "lines"),
      legend.key.height = unit(1, "lines"),
      plot.title = element_text(hjust = 0.5)  # per centrare il titolo
    )
})

plot_list
```
 
#MuSC annotation correction
MuSC are defined as cells where Pax7 gene is expressed.
```{r}
#IMPORTANTE: DEVO ANCHE TOGLIERE QUELLI DOVE NON E' ESPRESSO?
multiome_sce <- readRDS("~/multiome_sce.rds")
table(multiome_sce$subclusters == "MuSC",counts(multiome_sce)["Pax7", ] > 0)
#nel multiome non è così quindi intanto le lascio

subset_list <- lapply(subset_list, function(spe) {
  print(table(spe$cell_type == "MuSC"))
  pax7_pos <- counts(spe)["Pax7", ] > 0
  spe$cell_type[pax7_pos] <- "MuSC"
  print(table(spe$cell_type == "MuSC"))
  return(spe)
})
save(subset_list,file="subset_list.RData")

```


#Creo un oggetto spatial unico e indago se i MuSC aumentano tra c26 e sham
```{r}
for (nm in names(subset_list)) {
  spe <- subset_list[[nm]]
  colData(spe)$sample_id <- rep(nm, ncol(spe))  
  subset_list[[nm]] <- spe
}

spe_list <- subset_list[names(subset_list)]
exclude_names <- c("sham_b7", "c26STAT3_b7", "c26_b7")
combined_spe_wob7 <- do.call(
  cbind, 
  spe_list[!(names(spe_list) %in% exclude_names)]
)
table(colData(combined_spe_wob7)$sample_id)

rm(subset_list)
#REMOVING NAs
keep <- !is.na(combined_spe_wob7$cell_type)
combined_spe_wob7[,keep]
save(combined_spe_wob7, file="combined_spe_wob7.RData")

table(combined_spe_wob7$cell_type=="MuSC",combined_spe_wob7$tissue_type)
prop.table(table(combined_spe_wob7$cell_type=="MuSC",combined_spe_wob7$tissue_type))
#sono di più negli sham che nei c26 e molte di più nei trattamenti (torna!)
table(combined_spe_wob7$cell_type=="MuSC",combined_spe_wob7$sample_id)

#Modello binomiale per testare l'effetto della condizione
y <- ifelse(combined_spe_wob7$cell_type=="MuSC",1,0)

combined_spe_wob7$tissue_type <- relevel(combined_spe_wob7$tissue_type, ref = "sham")

mod_mixed <- glmer(
  I(cell_type == "MuSC") ~ tissue_type + (1 | sample_id),
  data = as.data.frame(colData(combined_spe_wob7)),
  family = binomial
)

summary(mod_mixed) 
#si confermano le previsioni: con c26 diminuiscono rispetto a sham e con i trattamenti aumentano

#visualizzazione?
y <- prop.table(table(combined_spe_wob7$cell_type=="MuSC",combined_spe_wob7$sample_id))[2,]
x <- c(rep("c26",3),rep("c26fox0",4),rep("c26murf1",4),rep("c26SMAD23",4),rep("c26STAT3",3),rep("sham",3))
x <- as.factor(x)
png("boxplot.png", width = 800, height = 600, res = 120)
boxplot(y ~ x)
```






 
 
 
 
 
 
 