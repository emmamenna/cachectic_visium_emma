---
title: "DEG_senzaB7"
output: html_document
date: "2025-09-05"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Guardando i risultati della deconvoluzione si vede che la quantità di NA nei campioni del blocco 7
non si limita ai lati (tessuto connettivo) ma è molto diffusa, 
probabilmente evidenziando una scarsa qualità dei campioni. Effettivamente il blocco 7
risultava particolarmente svantaggiato anche nelle analisi esplorative, in riferimento
in particolare al numero totale di UMI per blocco (vedi file tab_rias).

```{r, include=FALSE}
library(arrow)
library(Banksy)
library(BiocParallel)
library(DropletUtils)
library(dplyr)
library(edgeR)
library(ggplot2)
library(graphics)
library(igraph)
library(jsonlite)
library(Matrix)
library(matrixStats)
library(OSTA.data)
library(patchwork)
library(pheatmap)
library(S4Vectors)
library(scDblFinder)
library(scater)
library(scran)
library(scuttle)
library(SingleCellExperiment)
library(SpatialExperiment)
library(SummarizedExperiment)
library(tidyr)
library(VisiumIO)
library(spacexr)
library(SpotSweeper)
library(ggspavis)
library(openxlsx)
```

#dataset senza b7 (NON RIPETERE)
```{r}
# load("~/subset_list.RData")
# 
# #per distinguere poi i vari campioni
# for (nm in names(subset_list)) {
#   spe <- subset_list[[nm]]
#   colData(spe)$sample_id <- rep(nm, ncol(spe))  
#   subset_list[[nm]] <- spe
# }
# 
# spe_list <- subset_list[names(subset_list)]
# exclude_names <- c("sham_b7", "c26STAT3_b7", "c26_b7")
# combined_spe <- do.call(
#   cbind, 
#   spe_list[!(names(spe_list) %in% exclude_names)]
# )
# table(colData(combined_spe)$sample_id)
# 
# rm(subset_list)
# # Create pseudo-bulk for each cell_type in each sample
# pb_without_b7 <- aggregateAcrossCells(combined_spe, use.assay.type = "counts", 
#                                 id=DataFrame(label = combined_spe$cell_type,
#                                              sample = combined_spe$sample_id))
# pb_without_b7  <- logNormCounts(pb_without_b7) #altre normalizzazioni?
# colnames(pb_without_b7 ) <- paste(pb_without_b7$cell_type, pb_without_b7$sample_id, sep = "_")
# saveRDS(pb_without_b7 , file = "pb_wb7.rds")

```


#CORREZIONE EFFETTO DI BATCH (non cambia nulla e non c'era bisogno)
```{r}

#NB: sarebbe anche da riprovare a filtrare i geni

pb_mult <- readRDS("~/pb_wb7.rds")

#COMBAT
library(sva)
expr <- assay(pb_mult, "logcounts") 
colData(pb_mult)$block <- gsub(".*_", "", colData(pb_mult)$sample_id)
batch <- colData(pb_mult)$block

expr_combat <- ComBat(
  dat = as.matrix(expr),  # matrice numerica
  batch = batch,
  par.prior = TRUE,
  prior.plots = FALSE
)

assay(pb_mult,"logcounts") <- expr_combat

#NON CAMBIA MOLTO, INFATTI ANCHE I RISULTATI DELLA DEG POI SONO UGUALI
pca_before <- prcomp(t(expr))
pca_after  <- prcomp(t(expr_combat))

pca_df_before <- data.frame(pca_before$x[,1:2], batch = batch)
pca_df_after  <- data.frame(pca_after$x[,1:2],  batch = batch)

ggplot(pca_df_before, aes(x = PC1, y = PC2, color = batch)) +
  geom_point(size = 3) +
  theme_minimal() +
  ggtitle("Before ComBat")

ggplot(pca_df_after, aes(x = PC1, y = PC2, color = batch)) +
  geom_point(size = 3) +
  theme_minimal() +
  ggtitle("After ComBat")

```

#DEGs FOR ALL SAMPLE TYPES WITHOUT B7
```{r}
#pb_mult <- readRDS("~/pb_wb7.rds")

lrt_list <- list()
summary_list <- list()

contrast_list <- list(
  "C26_vs_SHAM"   = c("tissue_typec26 - tissue_typesham"),
  "FOXO_vs_C26"   = c("-tissue_typec26"),
  "FOXO_vs_SHAM"  = c("-tissue_typesham"),
  "STAT3_vs_C26"  = c("tissue_typec26STAT3 - tissue_typec26"),
  "STAT3_vs_SHAM" = c("tissue_typec26STAT3 - tissue_typesham"),
  "MURF1_vs_C26"  = c("tissue_typec26murf1 - tissue_typec26"),
  "MURF1_vs_SHAM" = c("tissue_typec26murf1 - tissue_typesham"),
  "SMAD23_vs_C26" = c("tissue_typec26SMAD23 - tissue_typec26"),
  "SMAD23_vs_SHAM"= c("tissue_typec26SMAD23 - tissue_typesham")
)

for (contrast_name in names(contrast_list)) {
  lrt_list[[contrast_name]] <- list()
  
  for (cell_type in unique(pb_mult$cell_type)) {
    ct_pb <- pb_mult[, pb_mult$cell_type == cell_type]
    y <- DGEList(counts(ct_pb), samples = as.data.frame(colData(ct_pb)))
    keep <- filterByExpr(y, group = y$samples$tissue_type)
    y <- y[keep,, keep.lib.sizes=FALSE]
    y <- calcNormFactors(y) 
    design <- model.matrix(~ 0 + tissue_type, y$samples)
    y <- estimateDisp(y, design)
    fit <- glmFit(y, design)
    
    contrast <- makeContrasts(contrasts = contrast_list[[contrast_name]], levels = design)
    
    lrt <- glmLRT(fit, contrast = contrast)
    res <- topTags(lrt, n = Inf)$table
    res$significant <- res$FDR < 0.05
    
    sig <- res[res$significant, ]
    sig_up <- sig[sig$logFC >= 0, ]
    sig_down <- sig[sig$logFC < 0, ]
    
    lrt_list[[contrast_name]][[cell_type]] <- list(
      full = res,
      sig = sig,
      up = sig_up,
      down = sig_down
    )
    
    gene_summary <- data.frame(
      contrast = contrast_name,
      cell_type = cell_type,
      Geni_considerati = nrow(res),
      Geni_significativi = nrow(sig),
      Upregolati = nrow(sig_up),
      Downregolati = nrow(sig_down)
    )
    
    summary_list[[length(summary_list) + 1]] <- gene_summary
  }
}

# Tabella riassuntiva
summary_df <- do.call(rbind, summary_list)
print(summary_df)

out_file <- "~/summary_contrasts.xlsx"
wb <- createWorkbook()

# Aggiungo uno sheet per ogni contrasto con la tabella completa
for (contrast_name in unique(summary_df$contrast)) {
  contrast_table <- subset(summary_df, contrast == contrast_name)
  
  addWorksheet(wb, contrast_name)
  writeData(wb, contrast_name, contrast_table)
}

saveWorkbook(wb, out_file, overwrite = TRUE)


```
#per salvare tutti i risultati
```{r}
library(openxlsx)

outdir <- "results_excel"
if (!dir.exists(outdir)) dir.create(outdir)

for (contrast_name in names(lrt_list)) {
  wb <- createWorkbook()
  
  for (cell_type in names(lrt_list[[contrast_name]])) {
    res     <- lrt_list[[contrast_name]][[cell_type]]$full
    sig     <- lrt_list[[contrast_name]][[cell_type]]$sig
    sig_up  <- lrt_list[[contrast_name]][[cell_type]]$up
    sig_down<- lrt_list[[contrast_name]][[cell_type]]$down
    
    # nome foglio pulito
    clean_name <- gsub("[^[:alnum:]_]", "_", cell_type)
    
    # foglio per cell_type con sottosezioni
    addWorksheet(wb, paste0(clean_name, "_all"))
    writeData(wb, paste0(clean_name, "_all"), res, rowNames = TRUE)
    
    addWorksheet(wb, paste0(clean_name, "_sig"))
    writeData(wb, paste0(clean_name, "_sig"), sig, rowNames = TRUE)
    
    addWorksheet(wb, paste0(clean_name, "_up"))
    writeData(wb, paste0(clean_name, "_up"), sig_up, rowNames = TRUE)
    
    addWorksheet(wb, paste0(clean_name, "_down"))
    writeData(wb, paste0(clean_name, "_down"), sig_down, rowNames = TRUE)
  }
  
  # salva il file excel del contrasto
  clean_contrast <- gsub("[^[:alnum:]_]", "_", contrast_name)
  saveWorkbook(wb, file.path(outdir, paste0("dge_", clean_contrast, ".xlsx")), overwrite = TRUE)
}

```


