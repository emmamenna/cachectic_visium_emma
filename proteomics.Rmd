---
title: "proteomica"
output: html_document
date: "2025-11-19"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(readxl)
library(SummarizedExperiment)
library(limma)
library(scater)
library(openxlsx)
```

NON RIFARE
#Lettura dati e conversione a summarized experiment
Sono dati di bulk proteomics
```{r}
cach_prot_data <- read_excel("~/per_git/cach_prot_data.xlsx",sheet="All data_intensity_(mixed)")
View(cach_prot_data)
dim(cach_prot_data)
cach_prot_data <- cach_prot_data[,-1]
sample_id <- as.vector(unlist(cach_prot_data[1,-1]))
condition <- as.vector(unlist(cach_prot_data[2,-1]))
illness <- as.vector(unlist(cach_prot_data[3,-1]))
sex <- as.vector(unlist(cach_prot_data[4,-1]))
coldata <- cbind(sample_id,condition,illness,sex)
head(coldata)
values <- as.matrix(cach_prot_data[-c(1:4),-1])
colnames(values) <- as.vector(cach_prot_data[1,-1])
rownames(values) <- as.vector(unlist(cach_prot_data[-c(1:4),1]))
head(values)
prot <- SummarizedExperiment(
  assays = list(counts = values),
  colData = coldata
)
prot

#salvo l'oggetto summarizedexperiment
save(prot,file="proteomic_se.rds")

```

#Analisi esplorative
```{r}
load("~/proteomic_se.rds")
mat <- assay(prot, "counts")
counts_num <- apply(mat, 2, function(x) as.numeric(as.character(x)))
rownames(counts_num) <- rownames(mat)
colnames(counts_num) <- colnames(mat)
assay(prot, "counts", withDimnames = FALSE) <- counts_num
boxplot(assay(prot, "counts"))
#non serve fare il log

#pca
pca <- prcomp(t(assay(prot, "counts")), scale. = TRUE)
col <- as.factor(colData(prot)$condition)
plot(pca$x[,1], pca$x[,2], col = col, pch = 19)
legend("topright", legend = unique(col), col = unique(col), pch = 19)

col <- as.factor(colData(prot)$illness)
plot(pca$x[,1], pca$x[,2], col = col, pch = 19)
legend("topright", legend = unique(col), col = unique(col), pch = 19)

col <- as.factor(colData(prot)$sex)
plot(pca$x[,1], pca$x[,2], col = col, pch = 19)
legend("topright", legend = unique(col), col = unique(col), pch = 19)

```

#DEG - modello semplice con limma
```{r}
#filtering proteins? it's bulk and I have 950 proteins so I wouldn't.

condition <- factor(prot$condition, levels= c("Control", "PreCac", "Cachexia"))
design <- model.matrix(~ 0 + condition)
y <- assay(prot,"counts")
fit <- lmFit(y, design)

contr.matrix <- makeContrasts(
  PreCac_vs_Control =  PreCac - Control,
  Cac_vs_PreCac = Cachexia - PreCac,
  Cac_vs_Control = Cachexia - Control,
  levels = design
)
contr.matrix

fit <- contrasts.fit(fit, contrasts = contr.matrix)
fit <- eBayes(fit)

top_PreCac_vs_Control <- topTable(fit, coef = "PreCac_vs_Control",p.value = 0.05, number = Inf) #54
top_Cac_vs_PreCac <- topTable(fit, coef = "Cac_vs_PreCac",p.value = 0.05, number = Inf) #176
top_Cac_vs_Control <- topTable(fit, coef = "Cac_vs_Control",p.value = 0.05, number = Inf)  #248

wb <- createWorkbook()

addWorksheet(wb, "PreCac_vs_Control")
writeData(wb, "PreCac_vs_Control", top_PreCac_vs_Control)
addWorksheet(wb, "Cac_vs_PreCac")
writeData(wb, "Cac_vs_PreCac", top_Cac_vs_PreCac)
addWorksheet(wb, "Cac_vs_Control")
writeData(wb, "Cac_vs_Control", top_Cac_vs_Control)
saveWorkbook(wb, file = "limma_results.xlsx", overwrite = TRUE)

```

#DEG con anche le altre variabili di interesse
```{r}
#Creo un'unica variabile per condition e illness perché il livello "control" che hanno è lo stesso.
cond_x_dis <- interaction(prot$condition, prot$illness, drop = TRUE)
levels(cond_x_dis) <- c("Control","Cac_CRC","PreCac_CRC","Cac_pan","PreCac_pan")
table(cond_x_dis)
sex <- prot$sex
design <- model.matrix(~ 0 + cond_x_dis + sex)
y <- assay(prot,"counts")
fit <- lmFit(y, design)

#confronti separati ----------------------------------------------------------------------------------------
contr.matrix <- makeContrasts(
  Cac_vs_PreCac_CRC = cond_x_disCac_CRC - cond_x_disPreCac_CRC,
  Cac_vs_PreCac_pan = cond_x_disCac_pan - cond_x_disPreCac_pan,
  Cac_vs_Control_CRC = cond_x_disCac_CRC - cond_x_disControl,
  Cac_vs_Control_pan = cond_x_disCac_pan - cond_x_disControl,
  PreCac_vs_Control_CRC = cond_x_disPreCac_CRC- cond_x_disControl,
  PreCac_vs_Control_pan = cond_x_disPreCac_pan - cond_x_disControl,
  levels = design
)
contr.matrix
fit <- contrasts.fit(fit, contrasts = contr.matrix)
fit <- eBayes(fit)

top_Cac_vs_PreCac_CRC <- topTable(fit, coef = "Cac_vs_PreCac_CRC",p.value = 0.05, number = Inf) #11
top_Cac_vs_PreCac_pan <- topTable(fit, coef = "Cac_vs_PreCac_pan",p.value = 0.05, number = Inf) #87
top_Cac_vs_Control_CRC <- topTable(fit, coef = "Cac_vs_Control_CRC",p.value = 0.05, number = Inf) #18
top_Cac_vs_Control_pan <- topTable(fit, coef = "Cac_vs_Control_pan",p.value = 0.05, number = Inf) #338
top_PreCac_vs_Control_CRC <- topTable(fit, coef = "PreCac_vs_Control_CRC",p.value = 0.05, number = Inf) #41
top_PreCac_vs_Control_pan <- topTable(fit, coef = "PreCac_vs_Control_pan",p.value = 0.05, number = Inf) #41

#confronto unico -------------------------------------------------------------------------------
#fa la media tra i due cac e sottrae la media tra i due precac
Cac_vs_PreCac <- c(
  Control      = 0,
  Cac_CRC      =  1/2,
  PreCac_CRC   = -1/2,
  Cac_pan      =  1/2,
  PreCac_pan   = -1/2,
  sexM = 0
)

Cac_vs_Control <- c(
  Control      = -1,
  Cac_CRC      =  1/2,
  PreCac_CRC   =  0,
  Cac_pan      =  1/2,
  PreCac_pan   =  0,
  sexM = 0
)

PreCac_vs_Control <- c(
  Control      = -1,
  Cac_CRC      =  0,
  PreCac_CRC   =  1/2,
  Cac_pan      =  0,
  PreCac_pan   =  1/2,
  sexM = 0
)

contrast_matrix <- cbind(
  Cac_vs_PreCac     = Cac_vs_PreCac,
  Cac_vs_Control    = Cac_vs_Control,
  PreCac_vs_Control = PreCac_vs_Control
)

fit2 <- contrasts.fit(fit, contrast_matrix)
fit2 <- eBayes(fit2, trend = TRUE)
topTable(fit2, coef = "Cac_vs_PreCac",p.value = 0.05, number = Inf) #53
topTable(fit2, coef = "Cac_vs_Control",p.value = 0.05, number = Inf) #134
topTable(fit2, coef = "PreCac_vs_Control",p.value = 0.05, number = Inf) #50

#Eventualmente si può fare anche una media pesata per paziente

```

#Per TESTARE (non solo correggere) anche per la variabile sex farei direttamente due modelli separati
#anche se perdo potenza
#se no devo fare un'interazione a 3
```{r}
#Creo un'unica variabile per condition e illness perché il livello "control" che hanno è lo stesso.
cond_x_dis <- interaction(prot$condition, prot$illness, drop = TRUE)
levels(cond_x_dis) <- c("Control","Cac_CRC","PreCac_CRC","Cac_pan","PreCac_pan")
table(cond_x_dis)
sex <- prot$sex

#SOLO MASCHI ----------------------------------------------------------------------------------------------
prot_m <- prot[,prot$sex == "M"]
cond_x_dis_m <- cond_x_dis[prot$sex == "M"]
design <- model.matrix(~ 0 + cond_x_dis_m)
y <- assay(prot_m,"counts")
fit <- lmFit(y, design)

#confronti separati ----------------------------------------------------------------------------------------
contr.matrix <- makeContrasts(
  Cac_vs_PreCac_CRC = cond_x_disCac_CRC - cond_x_disPreCac_CRC,
  Cac_vs_PreCac_pan = cond_x_disCac_pan - cond_x_disPreCac_pan,
  Cac_vs_Control_CRC = cond_x_disCac_CRC - cond_x_disControl,
  Cac_vs_Control_pan = cond_x_disCac_pan - cond_x_disControl,
  PreCac_vs_Control_CRC = cond_x_disPreCac_CRC- cond_x_disControl,
  PreCac_vs_Control_pan = cond_x_disPreCac_pan - cond_x_disControl,
  levels = design
)
contr.matrix
fit <- contrasts.fit(fit, contrasts = contr.matrix)
fit <- eBayes(fit)

top_Cac_vs_PreCac_CRC <- topTable(fit, coef = "Cac_vs_PreCac_CRC",p.value = 0.05, number = Inf) 
top_Cac_vs_PreCac_pan <- topTable(fit, coef = "Cac_vs_PreCac_pan",p.value = 0.05, number = Inf) 
top_Cac_vs_Control_CRC <- topTable(fit, coef = "Cac_vs_Control_CRC",p.value = 0.05, number = Inf)
top_Cac_vs_Control_pan <- topTable(fit, coef = "Cac_vs_Control_pan",p.value = 0.05, number = Inf)
top_PreCac_vs_Control_CRC <- topTable(fit, coef = "PreCac_vs_Control_CRC",p.value = 0.05, number = Inf)
top_PreCac_vs_Control_pan <- topTable(fit, coef = "PreCac_vs_Control_pan",p.value = 0.05, number = Inf) 

#confronto unico -------------------------------------------------------------------------------
#fa la media tra i due cac e sottrae la media tra i due precac
Cac_vs_PreCac <- c(
  Control      = 0,
  Cac_CRC      =  1/2,
  PreCac_CRC   = -1/2,
  Cac_pan      =  1/2,
  PreCac_pan   = -1/2
)

Cac_vs_Control <- c(
  Control      = -1,
  Cac_CRC      =  1/2,
  PreCac_CRC   =  0,
  Cac_pan      =  1/2,
  PreCac_pan   =  0
)

PreCac_vs_Control <- c(
  Control      = -1,
  Cac_CRC      =  0,
  PreCac_CRC   =  1/2,
  Cac_pan      =  0,
  PreCac_pan   =  1/2
)

contrast_matrix <- cbind(
  Cac_vs_PreCac     = Cac_vs_PreCac,
  Cac_vs_Control    = Cac_vs_Control,
  PreCac_vs_Control = PreCac_vs_Control
)

fit2 <- contrasts.fit(fit, contrast_matrix)
fit2 <- eBayes(fit2, trend = TRUE)
topTable(fit2, coef = "Cac_vs_PreCac",p.value = 0.05, number = Inf)
topTable(fit2, coef = "Cac_vs_Control",p.value = 0.05, number = Inf)
topTable(fit2, coef = "PreCac_vs_Control",p.value = 0.05, number = Inf)

#Eventualmente si può fare anche una media pesata per paziente

```




