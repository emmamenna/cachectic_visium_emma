---
title: "VISIUM_NON_HD"
output: html_document
date: "2025-10-08"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, include=FALSE}
library(arrow)
library(Banksy)
library(BiocParallel)
library(DropletUtils)
library(dplyr)
library(edgeR)
library(ggplot2)
library(graphics)
library(igraph)
library(jsonlite)
library(Matrix)
library(OSTA.data)
library(patchwork)
library(pheatmap)
library(S4Vectors)
library(scDblFinder)
library(scater)
library(scran)
library(scuttle)
library(SingleCellExperiment)
library(SpatialExperiment)
library(SummarizedExperiment)
library(tidyr)
library(VisiumIO)
library(spacexr)
library(SpotSweeper)
library(ggspavis)
library(purrr)
```

#Obiettivo: stessa analisi di deconvoluzione e confronto risultati

#Funzione per deconvoluzione con grafici
```{r}
run_my_rctd <- function(spe, sce_ref, out_prefix) {
  set.seed(9237)
  rownames(spe) <- rowData(spe)$symbol
  rownames(spe) <- make.unique(rownames(spe))
  
  #preparazione dataset
  rctd_data <- createRctd(
    spatial_experiment = spe,
    reference_experiment = sce_ref,
    cell_type_col = "subclusters"
  )
  
  #deconvoluzione
  results <- runRctd(rctd_data, rctd_mode = "multi")
  
  # Estrazione pesi
  ws <- assay(results, "weights")
  ws <- data.frame(t(as.matrix(ws)))
  colData(spe)[names(ws)] <- ws[colnames(spe), ] #salvo tutti i pesi in spe
  
  # Assegna cluster
  ids <- names(ws)[apply(ws, 1, which.max)]
  ids <- gsub("\\.([A-z])", " \\1", ids)
  idx <- match(colnames(spe), rownames(ws))
  spe$cell_type <- factor(ids[idx]) #salvo le annotazioni (peso di maggioranza)
  print(table(spe$cell_type))
  
  #Visualizzazione annotazioni
 your_color_vector <- c(
    "Endothelial" = "#0072B2",       # blu vivo
    "FAPs" = "#009E73",              # verde vivo
    "Immune_Cells" = "#D55E00",      # arancione-rosso
    "MuSC" = "#E69F00",              # arancione
    "Myonuclei_IIb" = "#CC79A7",     # magenta
    "Myonuclei_IIx" = "#56B4E9",     # azzurro chiaro
    "Myonuclei_IIx_IIa" = "#F0E442", # giallo
    "Myonuclei_IIx_IIb" = "#9B59B6", # viola chiaro
    "Myonuclei_MTJ" = "#0099B4",     # turchese
    "Myonuclei_NMJ" = "#DDAA33",     # senape
    "Myonuclei_Trim63" = "#CC3311",  # rosso scuro
    "Nervous_System" = "#44AA99",    # verde acqua
    "Pericyte" = "#AA4499",          # viola/rosa
    "Smooth_Muscular" = "#332288",   # blu-viola scuro
    "Tenocyte" = "#A3E635"           # verde lime
)

  stat1 <- plotCoords(spe, annotate = "cell_type", point_size = 5) +
    scale_color_manual(values = your_color_vector) +
    theme(
      legend.key.width = unit(0.5, "lines"),
      legend.key.height = unit(1, "lines")
    )
  
  ggsave(paste0(out_prefix, "_dec.png"), stat1, width = 10, height = 8, dpi = 300)
  
  assign("visium_list", replace(visium_list, out_prefix, spe), envir = .GlobalEnv)
  invisible(spe)
}
```

#lettura campioni e richiamo alla funzione sopra
```{r}

sce_ref <- readRDS("~/multiome_sce.rds")
load("~/visium_list.RData")
names(visium_list) <- c("C26Ctrl_1","C26Ctrl_2","Sham_1","Sham_2","Sham_3","C26T16_1","C26T16_2",
                        "C26T16_3","C26T17_1","C26T17_2","C26T17_3")

for (name in names(visium_list)) {
    run_my_rctd(visium_list[[name]], sce_ref, name)
}

save(visium_list,file="visium_list.RData")

```

#Grafico per tipi
```{r}

for (spe_name in names(visium_list)) {
  spe <- visium_list[[spe_name]]
  spatialCoords(spe) <- spatialCoords(spe)[, c(2, 1)]
  ws <- colData(spe)[,seq(8,22,1)]
  p <- lapply(names(ws), function(nm) {
  plotCoords(spe, annotate = nm, point_size = 0.1) +
    scale_color_gradientn(
      colors = rev(hcl.colors(9, "Rocket")),
      limits = c(0, 1)  # fissa scala da 0 a 1
    ) +
    ggtitle(nm)
  })

  final_plot <- wrap_plots(p, nrow = 3, ncol = 5, guides = "collect") &
  theme(
    legend.key.width = unit(0.5, "lines"),
    legend.key.height = unit(1, "lines"),
    strip.text = element_text(size = 5)
  ) &
  scale_color_gradientn(colors = rev(hcl.colors(9, "Rocket")), limits = c(0, 1))

  ggsave(paste0(spe_name, "_types.png"), final_plot, width = 10, height = 8, dpi = 300)
} 
```

Posso fare un confronto proporzioni (non spaziale)
e sarebbe figo fare un confronto anche spaziale tipo guardare le proporzioni
dentro lo spot di visium hd e la classificazione degli spot hd che ci stanno dentro
ma non so bene come. Corrispondenza campioni???

#Barplot per campione (quello aggregato direi che non ha senso)
```{r}

load("~/visium_list.RData")

# Costruisci un data frame con tutte le proporzioni per ogni oggetto
prop_df <- lapply(names(visium_list), function(name) {
  spe <- visium_list[[name]]
  tab <- table(spe$cell_type)
  prop <- prop.table(tab)
  data.frame(
    sample = name,
    cell_type = names(prop),
    proportion = as.numeric(prop)
  )
}) |> bind_rows()

your_color_vector <- c(
    "Endothelial" = "#0072B2",       # blu vivo
    "FAPs" = "#009E73",              # verde vivo
    "Immune_Cells" = "#D55E00",      # arancione-rosso
    "MuSC" = "#E69F00",              # arancione
    "Myonuclei_IIb" = "#CC79A7",     # magenta
    "Myonuclei_IIx" = "#56B4E9",     # azzurro chiaro
    "Myonuclei_IIx_IIa" = "#F0E442", # giallo
    "Myonuclei_IIx_IIb" = "#9B59B6", # viola chiaro
    "Myonuclei_MTJ" = "#0099B4",     # turchese
    "Myonuclei_NMJ" = "#DDAA33",     # senape
    "Myonuclei_Trim63" = "#CC3311",  # rosso scuro
    "Nervous_System" = "#44AA99",    # verde acqua
    "Pericyte" = "#AA4499",          # viola/rosa
    "Smooth_Muscular" = "#332288",   # blu-viola scuro
    "Tenocyte" = "#A3E635"           # verde lime
)

ggplot(prop_df, aes(x = sample, y = proportion, fill = cell_type)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = your_color_vector) +
  theme_minimal() +
  labs(
    title = "Proporzioni dei tipi cellulari per campione",
    x = "Campione (visium_list)",
    y = "Proporzione",
    fill = "Tipo Cellulare"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("prop_nonhd.png", width = 10, height = 6, dpi = 300)

```

#Tabelle proporzioni 
```{r}
#per campione
celltype_table <- lapply(names(visium_list), function(sample_name) {
  spe <- visium_list[[sample_name]]
  df <- as.data.frame(colData(spe))
  df <- df %>%
    group_by(cell_type) %>%
    summarise(count = n()) %>%
    mutate(proportion = count / sum(count),
           sample = sample_name)
  df
}) %>%
  bind_rows()

celltype_matrix <- celltype_table %>%
  select(sample, cell_type, proportion) %>%
  pivot_wider(names_from = cell_type, values_from = proportion, values_fill = 0)

celltype_matrix
library(writexl)
write_xlsx(celltype_matrix, "prop_nonhd.xlsx")

```

#Paragoni per campioni (giusto?)
```{r}
#C26T16_1 = murf1_b2
#C26T16_3 = murf1_b9
#C26T17_1 = murf1_b3
#C26T17_2 = murf1_b5

load("~/visium_list.RData")
load("~/subset_list.RData")

murf1_list <- subset_list[names(subset_list) %in% c("c26murf1_b2","c26murf1_b3","c26murf1_b5","c26murf1_b9")]
visium_list <- visium_list[names(visium_list) %in% c("C26T16_1","C26T16_3","C26T17_1","C26T17_2")]

names(visium_list) <- c("coor_b2","corr_b9","corr_b3","corr_b5")

prop_df_nnhd <- lapply(names(visium_list), function(name) {
  spe <- visium_list[[name]]
  tab <- table(spe$cell_type)
  prop <- prop.table(tab)
  data.frame(
    sample = name,
    cell_type = names(prop),
    proportion = as.numeric(prop)
  )
}) |> bind_rows()

ggplot(prop_df_nnhd, aes(x = sample, y = proportion, fill = cell_type)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = your_color_vector) +
  theme_minimal() +
  labs(
    title = "Proporzioni dei tipi cellulari per campione",
    x = "Campione (visium_list)",
    y = "Proporzione",
    fill = "Tipo Cellulare"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("prop_confr_NNHD.png", width = 10, height = 6, dpi = 300)

prop_df <- lapply(names(murf1_list), function(name) {
  spe <- murf1_list[[name]]
  tab <- table(spe$cell_type)
  prop <- prop.table(tab)
  data.frame(
    sample = name,
    cell_type = names(prop),
    proportion = as.numeric(prop)
  )
}) |> bind_rows()

ggplot(prop_df, aes(x = sample, y = proportion, fill = cell_type)) +
  geom_bar(stat = "identity") +
  scale_fill_manual(values = your_color_vector) +
  theme_minimal() +
  labs(
    title = "Proporzioni dei tipi cellulari per campione",
    x = "Campione (murf1_list)",
    y = "Proporzione",
    fill = "Tipo Cellulare"
  ) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

ggsave("murf1_HD.png", width = 10, height = 6, dpi = 300)

```

